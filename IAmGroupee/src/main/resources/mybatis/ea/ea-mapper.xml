<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="ea">
<!-- 관리자 -->
	<!-- 초기설정 확인 및 기본설정 데이터 확인 -->
	<select id="defaultSettings" resultType="com.kh.iag.ea.entity.SettingsDto">
		SELECT A.SEC_MIN SECMINA,
				B.SEC_MIN SECMINB,
				F.FORMAT_YEAR,
				F.FORMAT_DEPT,
				F.FORMAT_FORM
		FROM EA_SEC_A A, EA_SEC_B B, EA_FORMAT F
	</select>
	
	<!-- 문서 초기 설정 업데이트 -->
	<insert id="insertInitialSettings1" parameterType="com.kh.iag.ea.entity.SettingsDto">
		INSERT INTO EA_SEC_A (SEC_GRADE, SEC_MIN) VALUES (DEFAULT, ${secMinA})
	</insert>
	<insert id="insertInitialSettings2" parameterType="com.kh.iag.ea.entity.SettingsDto">
		INSERT INTO EA_SEC_B (SEC_GRADE, SEC_MIN) VALUES (DEFAULT, ${secMinB})
	</insert>
	<insert id="insertInitialSettings3" parameterType="com.kh.iag.ea.entity.SettingsDto">
		INSERT INTO EA_FORMAT (FORMAT_NO, FORMAT_YEAR, FORMAT_DEPT, FORMAT_FORM) VALUES (1, #{formatYear}, #{formatDept}, #{formatForm})
	</insert>
	
	<!-- 직위 데이터 -->
	<select id="positionValues" resultType="com.kh.iag.ea.entity.PositionDto">
		SELECT * FROM POSITION ORDER BY POSITION_LEVEL
	</select>
	
	<!-- 문서 설정 업데이트 -->
	<update id="updateSettings1" parameterType="com.kh.iag.ea.entity.SettingsDto">
		UPDATE EA_SEC_A SET SEC_MIN = ${secMinA} WHERE SEC_GRADE = 'A'
	</update>
	<update id="updateSettings2" parameterType="com.kh.iag.ea.entity.SettingsDto">
		UPDATE EA_SEC_B SET SEC_MIN = ${secMinB} WHERE SEC_GRADE = 'B'
	</update>
	<update id="updateSettings3" parameterType="com.kh.iag.ea.entity.SettingsDto">
		UPDATE EA_FORMAT SET FORMAT_YEAR = #{formatYear}, FORMAT_DEPT = #{formatDept}, FORMAT_FORM = #{formatForm} WHERE FORMAT_NO = 1
	</update>
	
	<!--카테고리 데이터 -->
	<select id="categoryValues" resultType="com.kh.iag.ea.entity.CategoryDto">
		SELECT * FROM EA_CATEGORY ORDER BY CATEGORY_NO
	</select>
	
	<!-- 양식 데이터 -->
	<select id="formValues" resultType="eaform">
		SELECT * 
		FROM EA_FORM F 
		JOIN EA_CATEGORY C ON(F.CATEGORY_NO = C.CATEGORY_NO)
	</select>
	
	<!-- 양식관리 카테고리 추가 -->
	<insert id="insertFormCategory">
		INSERT INTO EA_CATEGORY
		(CATEGORY_NO, CATEGORY_NAME)
		VALUES
		(SEQ_EA_CATEGORY_NO.NEXTVAL, '새로운 카테고리')
	</insert>
	
	<!-- 새로 추가한 카테고리 정보 가져오기 -->
	<select id="selectLatestFormCategory" resultType="com.kh.iag.ea.entity.CategoryDto">
		SELECT * FROM (SELECT ROWNUM AS RNUM, c.* FROM (SELECT * FROM EA_CATEGORY ORDER BY CATEGORY_NO DESC) c) WHERE RNUM = 1
	</select>
	
	<!-- 카테고리 삭제 -->
	<delete id="deleteFormCategory" parameterType="string">
		DELETE FROM EA_CATEGORY WHERE CATEGORY_NO = ${categoryNo}
	</delete>
	
	<!-- 양식관리 양식 추가  -->
	<insert id="insertForm" parameterType="string">
		INSERT INTO EA_FORM 
		(
			FORM_NO
			, FORM_TITLE
			, FORM_CONTENT
			, FORM_YEARS
			, CATEGORY_NO
		)
		VALUES 
		(
			SEQ_EA_FORM_NO.NEXTVAL
			, '새로운 양식'
			, '&lt;h1 style="text-align:center"&gt;새로운 양식&lt;/h1&gt;'
			, 1
			, ${categoryNo}
		)
	</insert>
	
	<!-- 새로 추가한 양식 정보 가져오기 -->
	<select id="selecLatestForm" resultType="eaform" >
		SELECT * FROM (SELECT ROWNUM AS RNUM, f.* FROM (SELECT * FROM EA_FORM ORDER BY FORM_NO DESC) f) WHERE RNUM = 1
	</select>
	
	<!-- 양식 삭제 -->
	<delete id="deleteForm" parameterType="string">
		DELETE FROM EA_FORM WHERE FORM_NO = ${formNo}
	</delete>
	
	<!-- 양식 카테고리 이름 변경 -->
	<update id="updateCategoryName" parameterType="com.kh.iag.ea.entity.CategoryDto">
		UPDATE EA_CATEGORY SET CATEGORY_NAME = #{categoryName} WHERE CATEGORY_NO = ${categoryNo}
	</update>
	
	<!-- 양식 이름 변경 -->
	<update id="updateFormName" parameterType="eaform">
		UPDATE EA_FORM SET FORM_TITLE = #{formTitle} WHERE FORM_NO = ${formNo}
	</update>
	
	<!-- 양식 수정 페이지 선택 양식 default 데이터 -->
	<select id="formValue" parameterType="eaform" resultType="eaform">
		SELECT * FROM EA_FORM WHERE FORM_NO = ${formNo}
	</select>
	
	<!-- 양식 수정 -->
	<update id="editForm" parameterType="eaform">
		UPDATE EA_FORM 
		SET
		    FORM_TITLE = #{formTitle},
		    FORM_CONTENT = #{formContent},
		    FORM_YEARS = ${formYears},
		    CATEGORY_NO = ${categoryNo}
		WHERE FORM_NO = ${formNo}
	</update>
<!-- 사용자 -->
	<!-- 기안 작성 페이지 양식 데이터 -->
	<select id="signupFormValue" parameterType="eaform" resultType="eaform">
		SELECT * FROM EA_FORM WHERE FORM_NO = ${formNo}
	</select>
	
	<!-- 기안 작성 페이지 부서 데이터 -->
	<select id="deptValues" resultType="com.kh.iag.ea.entity.DeptDto">
		SELECT DEPARTMENT_NO, DEPARTMENT_NAME FROM DEPARTMENT
	</select>
	
	<!-- 기안 작성 페이지 사원 데이터 -->
	<select id="userValues" parameterType="string" resultType="com.kh.iag.ea.entity.EAUserDto">
		SELECT A.USER_NO, A.NAME, A.DEPARTMENT_NO, A.DEPARTMENT_NAME, P.POSITION_NO, P.POSITION_NAME, P.POSITION_LEVEL 
		FROM
		(
		    SELECT U.USER_NO, U.NAME, D.DEPARTMENT_NO, D.DEPARTMENT_NAME, U.POSITION_NO
		    FROM IAG_USER U 
		    JOIN DEPARTMENT D ON(U.DEPARTMENT_NO = D.DEPARTMENT_NO)
		    WHERE ACTIVITY_YN = 'Y' AND USER_NO != #{userNo}
		) A 
		JOIN POSITION P ON(A.POSITION_NO = P.POSITION_NO)
		ORDER BY P.POSITION_LEVEL
	</select>
	
	<!-- 기안 신청시 결재선번호 테이블 인서트 -->
	<insert id="insertProcessNo" parameterType="com.kh.iag.ea.entity.ProcessDto">
		INSERT INTO EA_PROCESS_NO
		(
			PROC_NO,
			DOC_NO
		)
		VALUES
		(
			SEQ_EA_PROCESS_NO.NEXTVAL,
			#{docNo}||SEQ_EA_DOC_NO.NEXTVAL
		)
	</insert>
	
	<!-- 기안 신청시 위에서 생성한 결재선번호 데이터 셀렉트 -->
	<select id="selectProcessNo" resultType="com.kh.iag.ea.entity.ProcessDto">
		SELECT PROC_NO, DOC_NO FROM (SELECT ROWNUM AS RNUM, p.* FROM (SELECT * FROM EA_PROCESS_NO ORDER BY PROC_NO DESC) p) WHERE RNUM = 1
	</select>
	
	<!-- 기안 신청시 결재선 테이블 인서트 -->
	<insert id="insertProcess" parameterType="com.kh.iag.ea.entity.ProcessDto">
		INSERT INTO EA_PROCESS
		(
			PROC_NO,
		    USER_NO,
		    PROC_SEP,
		    PROC_SEQ,
		    PROC_CNT
		)
		VALUES
		(
			${procNo},
			#{userNo},
			${procSep},
			${procSeq},
			${procCnt}
		)
	</insert>
	
	<!-- 기안 신청시 문서 테이블 인서트 -->
	<insert id="insertDocument" parameterType="eadocs">
		INSERT INTO EA_DOCUMENT
		(
			DOC_NO,
			USER_NO,
			FORM_NO,
			PROC_NO,
			DOC_TITLE,
			DOC_CONTENT,
			DOC_SLV,
			DOC_MAKE,
			DOC_CLOSE,
			DOC_SEP
		)
		VALUES
		(
			#{docNo},
			#{userNo},
			${formNo},
			${procNo},
			#{docTitle},
			#{docContent},
			#{docSlv},
			SYSDATE,
			#{docClose},
			'N'
		)
	</insert>
	
	<!-- 기안 작성시 참조자 테이블 인서트 -->
	<insert id="insertRef" parameterType="com.kh.iag.ea.entity.RefDto">
		INSERT INTO EA_REF
		(
			REF_NO,
			DOC_NO
		)
		VALUES
		(
			#{refNo},
			#{docNo}
		)
	</insert>
	
	<!-- 기안 작성시 작성한 문서 상세 페이지 문서 데이터 -->
	<select id="selectDocument" parameterType="com.kh.iag.ea.entity.ProcessDto" resultType="eadocs">
		SELECT D.*, U.NAME, P.POSITION_NAME, DP.DEPARTMENT_NAME, F.FORM_TITLE
		FROM 
		(
			SELECT * FROM EA_DOCUMENT
			WHERE DOC_NO = #{docNo}
		) D
		JOIN IAG_USER U ON(D.USER_NO = U.USER_NO)
		JOIN POSITION P ON(U.POSITION_NO = P.POSITION_NO)
		JOIN DEPARTMENT DP ON(U.DEPARTMENT_NO = DP.DEPARTMENT_NO)
		JOIN EA_FORM F ON(D.FORM_NO = F.FORM_NO)
	</select>
	
	
	<!-- 기안 작성시 작성한 문서 상세 페이지 결재선 데이터 -->
	<select id="selectProcess" parameterType="com.kh.iag.ea.entity.ProcessDto" resultType="com.kh.iag.ea.entity.ProcessDto">
		SELECT P.*, U.NAME, PS.POSITION_NAME, DP.DEPARTMENT_NAME
		FROM 
		(
			SELECT * 
			FROM EA_PROCESS
			WHERE PROC_NO = ${procNo}
			ORDER BY PROC_SEP
		) P
		JOIN IAG_USER U ON(P.USER_NO = U.USER_NO)
		JOIN POSITION PS ON(U.POSITION_NO = PS.POSITION_NO)
		JOIN DEPARTMENT DP ON(U.DEPARTMENT_NO = DP.DEPARTMENT_NO)
	</select>
	
	
	<!-- 기안리스트조회 내가 기안한 문서 리스트 데이터 -->
	<select id="signupList" parameterType="hashMap" resultType="eadocs">
		SELECT * FROM
		(
		    SELECT ROWNUM RN, T.*
		    FROM
		    (
		    SELECT D.*, U.NAME, P.POSITION_NAME, DP.DEPARTMENT_NAME, F.FORM_TITLE
		    FROM 
		    (
		        SELECT * FROM EA_DOCUMENT
		        WHERE USER_NO = 'user6' AND DOC_SEP = 'N'
		        ORDER BY DOC_MAKE DESC
		    ) D
		    JOIN IAG_USER U ON(D.USER_NO = U.USER_NO)
		    JOIN POSITION P ON(U.POSITION_NO = P.POSITION_NO)
		    JOIN DEPARTMENT DP ON(U.DEPARTMENT_NO = DP.DEPARTMENT_NO)
		    JOIN EA_FORM F ON(D.FORM_NO = F.FORM_NO)
		    ) T
		)
		WHERE RN BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 기안리스트조회 결재선 정의 데이터 -->
	<select id="processList" parameterType="string" resultType="com.kh.iag.ea.entity.ProcessDto">
		SELECT D.DOC_NO, PC.*
		FROM 
		(
		    SELECT * FROM EA_DOCUMENT
		    WHERE USER_NO = #{userNo} AND DOC_SEP = 'N'
		    ORDER BY DOC_MAKE DESC
		) D
		JOIN IAG_USER U ON(D.USER_NO = U.USER_NO)
		JOIN POSITION P ON(U.POSITION_NO = P.POSITION_NO)
		JOIN DEPARTMENT DP ON(U.DEPARTMENT_NO = DP.DEPARTMENT_NO)
		JOIN EA_FORM F ON(D.FORM_NO = F.FORM_NO)
		JOIN EA_PROCESS PC ON(D.PROC_NO = PC.PROC_NO)
	</select>
	
	<!-- 기안리스트조회 로우 카운트 -->
	<select id="getSignupListCnt" parameterType="string" resultType="int">
		SELECT COUNT(D.DOC_NO)
		FROM 
		(
		    SELECT * FROM EA_DOCUMENT
		    WHERE USER_NO = #{userNo} AND DOC_SEP = 'N'
		    ORDER BY DOC_MAKE DESC
		) D
		JOIN IAG_USER U ON(D.USER_NO = U.USER_NO)
		JOIN POSITION P ON(U.POSITION_NO = P.POSITION_NO)
		JOIN DEPARTMENT DP ON(U.DEPARTMENT_NO = DP.DEPARTMENT_NO)
		JOIN EA_FORM F ON(D.FORM_NO = F.FORM_NO)
	</select>
</mapper>